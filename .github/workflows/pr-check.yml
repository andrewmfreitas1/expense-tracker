name: Pull Request Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  quality-check:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run linter
      run: npm run lint

    - name: Run type check
      run: npx tsc --noEmit

    - name: Run tests
      run: npm run test:ci

    - name: Comment PR with results
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const coverage = fs.existsSync('./coverage/coverage-summary.json')
            ? JSON.parse(fs.readFileSync('./coverage/coverage-summary.json', 'utf8'))
            : null;
          
          let comment = '## üß™ Test Results\n\n';
          
          if (coverage) {
            const { total } = coverage;
            comment += `### Coverage Summary\n\n`;
            comment += `- **Lines**: ${total.lines.pct}%\n`;
            comment += `- **Statements**: ${total.statements.pct}%\n`;
            comment += `- **Functions**: ${total.functions.pct}%\n`;
            comment += `- **Branches**: ${total.branches.pct}%\n\n`;
            
            const passing = total.lines.pct >= 70 && total.statements.pct >= 70;
            comment += passing ? '‚úÖ **Coverage threshold met!**' : '‚ö†Ô∏è **Coverage below threshold**';
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
